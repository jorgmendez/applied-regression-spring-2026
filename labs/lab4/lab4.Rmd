---
title: "Lab 4"
author: "Jorge Mendez"
date: "2026-02-16"
output: word_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)

```

## Problem 1:  divusa (faraway)

```{r}
library(faraway)
data(divusa)
div = divusa
#head(div)
```


### (1a) Compute the Hat matrix, and calculate the model residuals using Hat matrix.

The following R code was used to compute the Hat matrix and the residuals using the matrix formulation:


```{r}
model=lm(divorce~. -year,data=divusa)
x=model.matrix(model)
xtx.inv = solve(t(x) %*% x)
h = x %*% xtx.inv %*% t(x)


fit.val = h%*% div$divorce
#head(fit.val)

id = diag(nrow(div))
res = (id - h)%*% div$divorce
#print(res)
#model$residuals


```
---

model = lm(divorce ~ . - year, data = divusa)

x = model.matrix(model)
xtx.inv = solve(t(x) %*% x)
h = x %*% xtx.inv %*% t(x)

fit.val = h %*% div$divorce

id = diag(nrow(div))
res = (id - h) %*% div$divorce


---



The Hat matrix was computed using
\[
H = X(X'X)^{-1}X'.
\]

The fitted values were obtained as
\[
\hat{y} = HY,
\]
and the residuals were calculated using
\[
e = (I - H)Y.
\]

The residuals obtained from the Hat matrix match the residuals from the fitted linear model.


### (1b) Calculate the standardized residuals(which can be checked by rstandard(model)
```{r}
standard.res <- rstandard(model)
standard.res

```
The standardized residuals were computed using 
\[
r_i = \frac{e_i}{\hat{\sigma}\sqrt{1 - h_{ii}}}.
\]
Observations 27, 47, 48, and 49 have standardized residuals with absolute values greater than 2, indicating potential outliers. However, none exceed 3 in absolute value, so there are no strong outliers.


### (1c) Retrieve the diagonal of matrix H (which are called leverages). Summary of the leverages.
Use cutoff value to take out high leverages.
```{r}
leverage = hatvalues(model)

summary(leverage)

cutoff = 2 * mean(leverage)

which(leverage > cutoff)

```
The leverages were obtained as the diagonal elements of the Hat matrix. Since the mean leverage equals $\frac{p}{n}$, the cutoff value $2\frac{p}{n}$ is equivalent to $2 \times \text{mean leverage}$, which is approximately 0.156. Observations 13, 14, 24, 25, 26, and 27 have leverage values exceeding this cutoff and are considered high leverage points.



### (1d) Calculate the Cook distances, plot Cook distance [as in 3]. Suggest any outliers need to take out?

```{r}
cook = cooks.distance(model)

plot(cook, main = 'Cooks Distance')
abline(h = 4/length(cook), col="red", lty=2)

which(cook > (4 / length(cook)))


```

Cook’s distance was calculated for each observation. Using the cutoff value 
\[
\frac{4}{n},
\]
observations 2, 26, and 27 were identified as potentially influential. 

However, none of the Cook’s distances exceed 1, indicating that there are no highly influential observations that require removal.

### (1e) Perform a complete Residual analysis.
```{r}
par(mfrow=c(2,2))
plot(model)


shapiro.test((residuals(model)))

library(lmtest)
bptest(model)

dwtest(model)
```

A complete residual analysis was performed. 

The Shapiro-Wilk test yielded a p-value of 0.724, indicating no evidence against normality of the residuals. 

The Breusch-Pagan test resulted in a p-value of 0.0049, suggesting the presence of heteroscedasticity. 

The Durbin-Watson test produced a very small p-value (< 0.001) with a statistic of 0.30, indicating strong positive autocorrelation in the residuals. 

Overall, while the normality assumption appears reasonable, the assumptions of constant variance and independence are violated.


## Problem 2

### (2a) Construct a normal probability plot of the residuals. Does there seem to be any problem with the normality assumption 

```{r}
volume <- c(2084,2084,2273,2273,2273,2463,2463,2651,2652,2652,2842,
            2842,3030,3031,3031,3221,3221,3409,3410,3600,3600,3788,
            3789,3789,3979,3979,4167,4168,4168,4358,4358,4546,4547)

pressure <- c(4599,4600,5044,5043,5044,5488,5487,5931,5932,5932,6380,
              6380,6818,6817,6818,7266,7268,7709,7710,8156,8158,8597,
              8599,8600,9048,9048,9484,9487,9487,9936,9938,10377,10379)


```

```{r}
model2 <- lm(pressure ~ volume)
summary(model2)

qqnorm(residuals(model2))
qqline(residuals(model2), col="red")

```

The normal probability plot does not suggest a serious departure from normality. While there is slight deviation in the lower tail, the residuals appear approximately normally distributed.

### (2b) Construct and interpret a plot of the residuals versus the predicted response

```{r}
# Residuals vs Fitted
plot(fitted(model2), residuals(model2),
     main = "Residuals vs Fitted",
     xlab = "Fitted Values",
     ylab = "Residuals",
     pch = 16)

abline(h = 0, col = "red", lty = 2)

```

The residuals versus fitted values plot shows a random scatter around zero with no clear pattern or curvature. The spread of residuals appears approximately constant across fitted values. This suggests that the assumptions of linearity and constant variance are reasonable.

### (2c) Suppose that the data was collected in the order shown in the table. plot the residuals versus time order and comment on the plot

```{r}
# Residuals vs Time Order
plot(seq_along(residuals(model2)),
     residuals(model2),
     type = "b",
     pch = 16,
     main = "Residuals vs Time Order",
     xlab = "Observation Order",
     ylab = "Residuals")

abline(h = 0, col = "red", lty = 2)


```

The residuals versus time order plot shows noticeable patterns and clustering rather than random scatter. There appear to be runs of positive and negative residuals, suggesting potential lack of independence. This indicates possible autocorrelation in the residuals.

## Problem 3

```{r}
temp <- c(273,283,293,303,313,323,333,343,353,363,373)

pressure <- c(4.6,9.2,17.5,31.8,55.3,92.5,149.4,233.7,355.1,525.8,760.0)

```

### (3a) Plot a scatter diagram. Does it seem likely that a straight line model will be  adequate

```{r}
plot(temp, pressure,
     pch=16,
     main="Vapor Pressure vs Temperature",
     xlab="Temperature (K)",
     ylab="Vapor Pressure (mm Hg)")

```

The scatter plot shows a strong increasing nonlinear pattern. The relationship between temperature and vapor pressure appears exponential rather than linear. Therefore, a straight-line model does not appear to be adequate.

### (3b) Fit the straight line model. Compute the summary statistics and the residual plots. What are your conclusions regarding model adequacy

```{r}
model3 <- lm(pressure ~ temp)
summary(model3)

par(mfrow = c(2,2))
plot(model3)
par(mfrow = c(1,1))


```

Although the straight-line model produces a relatively high $R^2$ value of 0.7981 and a significant slope coefficient, the residual plots show a clear curved pattern in the residuals versus fitted values plot. This indicates that the linear model does not adequately describe the relationship between temperature and vapor pressure. A transformation is needed to achieve a better model fit.



### (3c) From physical chemistry, the Clausius–Clapeyron equation suggests that $\ln(p_v)$ is approximately linear in $-1/T$. Repeat part (b) using the appropriate transformation based on this information.


```{r}
model3_trans <- lm(log(pressure) ~ I(-1/temp))
summary(model3_trans)

par(mfrow = c(2,2))
plot(model3_trans)
par(mfrow = c(1,1))

```

Using the transformation suggested by the Clausius–Clapeyron equation, a regression model was fitted with $\log(\text{pressure})$ as the response and $-1/T$ as the predictor. 

The transformed model produced an $R^2$ value of 0.9999, indicating an excellent fit. The residual plots show no clear curvature or systematic pattern, and the residuals appear approximately normally distributed with constant variance. 

Thus, the transformed model provides a substantially better and more appropriate fit than the original straight-line model.



#### log(Pressure) vs -1/Temperature

```{r}
plot(-1/temp, log(pressure),
     pch = 16,
     main = "log(Pressure) vs -1/Temperature",
     xlab = "-1/Temperature (1/K)",
     ylab = "log(Vapor Pressure)")
abline(model3_trans, col="red")

```

The transformed scatter plot of $\log(\text{pressure})$ versus $-1/T$ shows a strong linear relationship. The fitted regression line closely follows the data points, and the residual diagnostics indicate that the model assumptions are satisfied. The $R^2$ value of 0.9999 confirms that the Clausius–Clapeyron transformation provides an excellent fit. Therefore, the transformed model is substantially more appropriate than the original straight-line model.

